{% extends "base.html" %}

{% block title %}Capture Photo{% endblock %}

{% block content %}
    <h2 class="text-xl font-semibold mb-4">Take a Photo</h2>
    <div class="flex flex-col items-center">
        <video id="video" class="border rounded mb-4" width="320" height="240" autoplay></video>
        <button id="capture" class="bg-blue-600 text-white p-2 rounded mb-4">Capture Photo</button>
        <canvas id="canvas" class="border rounded mb-4" width="320" height="240" style="display: none;"></canvas>
        <img id="photo" src="" alt="Captured Photo" class="border rounded mb-4" style="display: none;">
        <button id="upload" class="bg-blue-600 text-white p-2 rounded">Upload Photo</button>
    </div>
    <div id="result" class="mt-4">
        <!-- Display result here -->
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const captureButton = document.getElementById('capture');
        const uploadButton = document.getElementById('upload');
        const resultDiv = document.getElementById('result');
        let photoBlob = null;

        // Access camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            })
            .catch(err => {
                console.error("Error accessing camera: ", err);
                resultDiv.innerHTML = `<p>Failed to access camera.</p>`;
            });

        // Capture photo
        captureButton.addEventListener('click', () => {
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            photo.src = canvas.toDataURL('image/png');
            photo.style.display = 'block';
            canvas.style.display = 'none';
            photoBlob = dataURLToBlob(photo.src);
        });

        // Upload photo
        uploadButton.addEventListener('click', async () => {
            if (!photoBlob) {
                resultDiv.innerHTML = `<p>No photo to upload.</p>`;
                return;
            }
            
            const formData = new FormData();
            formData.append('image', photoBlob, 'photo.png');
            
            // Upload the photo
            console.log('Uploading photo...');
            const uploadResponse = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const uploadResult = await uploadResponse.json();
            console.log('Upload response:', uploadResult); // Debugging

            if (uploadResult.url) {
                // Prepend the current domain to the image URL
                const imageUrl = new URL(uploadResult.url, window.location.origin).toString();
                console.log('Image URL with domain:', imageUrl); // Debugging

                // Analyze the uploaded image
                console.log('Analyzing image...');
                const analyzeResponse = await fetch('/analyze_image', {
                    method: 'POST',
                    body: JSON.stringify({ image_url: imageUrl }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const analyzeResult = await analyzeResponse.json();
                console.log('Analyze response:', analyzeResult); // Debugging
                
                if (analyzeResult.ingredients) {
                    // Redirect to the recipe page with the ingredients list
                    const ingredients = encodeURIComponent(analyzeResult.ingredients.join(', '));
                    window.location.href = `/recipe?ingredients=${ingredients}`;
                } else {
                    resultDiv.innerHTML = `<p>${analyzeResult.error || 'Failed to analyze image.'}</p>`;
                }
            } else {
                resultDiv.innerHTML = `<p>${uploadResult.error}</p>`;
            }
        });

        // Convert data URL to Blob
        function dataURLToBlob(dataURL) {
            const [header, data] = dataURL.split(',');
            const mimeString = header.split(':')[1].split(';')[0];
            const byteString = atob(data);
            const arrayBuffer = new ArrayBuffer(byteString.length);
            const uint8Array = new Uint8Array(arrayBuffer);
            for (let i = 0; i < byteString.length; i++) {
                uint8Array[i] = byteString.charCodeAt(i);
            }
            return new Blob([arrayBuffer], { type: mimeString });
        }
    </script>
{% endblock %}
